name: Build Rime Configs
on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  prepare-schemas:
    name: Prepare Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Fetch Schemas ğŸ“¥
        run: |
          bash fetch.sh

      - name: Cache Schemas ğŸ’¾
        uses: actions/cache@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

  build-for-weasel:
    name: Build for Weasel
    runs-on: ubuntu-latest
    needs: prepare-schemas
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Cache Schemas ğŸ’¾
        id: cache-schemas
        uses: actions/cache@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

      - name: Check Schema Cache âœ”ï¸
        if: steps.cache-schemas.outputs.cache-hit != 'true'
        uses: actions/github-script@v6
        with:
          script: core.setFailed('Cached schemas not found!')

      - name: Prepare User Settings ğŸ—‚ï¸
        run: |
          cp -r schemas/* weasel/
          cp lua/* weasel/lua/
          cat rime.lua >> weasel/rime.lua

      - name: Make Zip Archive ğŸ—„ï¸
        run: |
          zip -r -q weasel.zip weasel

      - name: Upload Artifact ğŸ“¤
        uses: actions/upload-artifact@v3
        with:
          name: weasel.zip
          path: weasel.zip

  build-for-hamster:
    name: Build for Hamster
    runs-on: ubuntu-latest
    needs: prepare-schemas
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Cache Schemas ğŸ’¾
        id: cache-schemas
        uses: actions/cache@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

      - name: Check Schema Cache âœ”ï¸
        if: steps.cache-schemas.outputs.cache-hit != 'true'
        uses: actions/github-script@v6
        with:
          script: core.setFailed('Cached schemas not found!')

      - name: Prepare User Settings ğŸ—‚ï¸
        run: |
          cp schemas/japanese.* hamster/
          cp schemas/shupin* hamster/
          cp lua/split.lua hamster/lua/
          cp lua/preedit.lua hamster/lua/
          cp schemas/rime.lua hamster/
          cat rime.lua >> hamster/rime.lua

      - name: Make Zip Archive ğŸ—„ï¸
        run: |
          zip -r -q hamster.zip hamster

      - name: Upload Artifact ğŸ“¤
        uses: actions/upload-artifact@v3
        with:
          name: hamster.zip
          path: hamster.zip
