name: Build Rime Configs
on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  prepare-schemas:
    name: Prepare Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Clear Cache âŒ
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh extension install actions/gh-actions-cache
          gh actions-cache delete ${{ runner.os }}-schemas --confirm
        continue-on-error: true

      - name: Install Dependencies âš™ï¸
        run: sudo apt-get install -y opencc

      - name: Fetch Schemas ğŸ“¥
        run: |
          bash fetch.sh

      - name: Cache Schemas ğŸ’¾
        uses: actions/cache/save@v3
        if: always()
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

  build-package:
    strategy:
      matrix:
        target: [ weasel, hamster ]
    name: Build Package for ${{ matrix.target }}
    runs-on: ubuntu-latest
    needs: prepare-schemas
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Cache Schemas ğŸ’¾
        id: cache-schemas
        uses: actions/cache/restore@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

      - name: Check Schema Cache âœ”ï¸
        if: steps.cache-schemas.outputs.cache-hit != 'true'
        uses: actions/github-script@v6
        with:
          script: core.setFailed('Cached schemas not found!')

      - name: Prepare User Settings for Weasel ğŸ¦¡
        if: ${{ matrix.target == 'weasel' }}
        run: |
          cp -r schemas/* ${{ matrix.target }}/ && \
          cp lua/* ${{ matrix.target }}/lua/ && \
          cp xkjd6.extended.dict.yaml ${{ matrix.target }}/ && \
          cat rime.lua >> ${{ matrix.target }}/rime.lua && \
          echo "prepare for ${{ matrix.target }} done."

      - name: Prepare User Settings for Hamster ğŸ¹
        if: ${{ matrix.target == 'hamster' }}
        run: |
          mkdir -p hamster/lua ${{ matrix.target }}/opencc && \
          cp schemas/japanese.* schemas/shupin* schemas/rime.lua ${{ matrix.target }}/ && \
          cp lua/* ${{ matrix.target }}/lua/ && \
          cp xkjd6.extended.dict.yaml ${{ matrix.target }}/ && \
          cp schemas/opencc/emoji* ${{ matrix.target }}/opencc/ && \
          cat rime.lua >> ${{ matrix.target }}/rime.lua && \
          echo "prepare for ${{ matrix.target }} done."

      - name: Make Zip Archive ğŸ—„ï¸
        run: |
          cd ${{ matrix.target }}
          zip -r -q ../${{ matrix.target }}.zip *

      - name: Upload Artifact ğŸ“¤
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.target }}.zip
          path: ${{ matrix.target }}.zip

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: build-package
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Download All Artifacts ğŸ“¥
        uses: actions/download-artifact@v3

      - name: Rename Release Zip Archives
        run: |
          mv weasel.zip/weasel.zip weasel-${{ github.ref_name }}.zip
          mv hamster.zip/hamster.zip hamster-${{ github.ref_name }}.zip

      - name: Create Release and Upload Assets ğŸš€
        uses: softprops/action-gh-release@v1
        with:
          files: |
            weasel-${{ github.ref_name }}.zip
            hamster-${{ github.ref_name }}.zip
