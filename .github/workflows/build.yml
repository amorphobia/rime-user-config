name: Build Rime Configs
on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  prepare-schemas:
    name: Prepare Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Install Dependencies ⚙️
        run: sudo apt-get install -y opencc

      - name: Fetch Schemas 📥
        run: |
          bash fetch.sh

      - name: Cache Schemas 💾
        uses: actions/cache/save@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

  build-for-weasel:
    name: Build for Weasel
    runs-on: ubuntu-latest
    needs: prepare-schemas
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Cache Schemas 💾
        id: cache-schemas
        uses: actions/cache/restore@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

      - name: Check Schema Cache ✔️
        if: steps.cache-schemas.outputs.cache-hit != 'true'
        uses: actions/github-script@v6
        with:
          script: core.setFailed('Cached schemas not found!')

      - name: Prepare User Settings 🗂️
        run: |
          cp -r schemas/* weasel/
          cp lua/* weasel/lua/
          cat rime.lua >> weasel/rime.lua

      - name: Make Zip Archive 🗄️
        run: |
          zip -r -q weasel.zip weasel

      - name: Upload Artifact 📤
        uses: actions/upload-artifact@v3
        with:
          name: weasel.zip
          path: weasel.zip

  build-for-hamster:
    name: Build for Hamster
    runs-on: ubuntu-latest
    needs: prepare-schemas
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Cache Schemas 💾
        id: cache-schemas
        uses: actions/cache/restore@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

      - name: Check Schema Cache ✔️
        if: steps.cache-schemas.outputs.cache-hit != 'true'
        uses: actions/github-script@v6
        with:
          script: core.setFailed('Cached schemas not found!')

      - name: Prepare User Settings 🗂️
        run: |
          mkdir -p hamster/lua
          mkdir -p hamster/opencc
          cp schemas/japanese.* hamster/
          cp schemas/shupin* hamster/
          cp lua/split.lua hamster/lua/
          cp lua/preedit.lua hamster/lua/
          cp schemas/rime.lua hamster/
          cat rime.lua >> hamster/rime.lua
          cp schemas/opencc/emoji* hamster/opencc/

      - name: Make Zip Archive 🗄️
        run: |
          cd hamster
          zip -r -q ../hamster.zip *

      - name: Upload Artifact 📤
        uses: actions/upload-artifact@v3
        with:
          name: hamster.zip
          path: hamster.zip

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [build-for-weasel, build-for-hamster]
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Download All Artifacts 📥
        uses: actions/download-artifact@v3

      - name: Rename Release Zip Archives
        run: |
          mv weasel.zip/weasel.zip weasel-${{ github.ref_name }}.zip
          mv hamster.zip/hamster.zip hamster-${{ github.ref_name }}.zip

      - name: Create Release and Upload Assets 🚀
        uses: softprops/action-gh-release@v1
        with:
          files: |
            weasel-${{ github.ref_name }}.zip
            hamster-${{ github.ref_name }}.zip
