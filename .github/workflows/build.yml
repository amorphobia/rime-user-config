name: Build Rime Configs
on:
  push:
    branches:
      - master
      - dev
    tags:
      - 'v*'

jobs:
  sanity-check:
    name: Dictionary Sanity Check ğŸ§
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Sanity Check ğŸ“„ï¸
        run: |
          bash scripts/sanity_check.sh

  prepare-schemas:
    name: Prepare Schemas ğŸ–¨ï¸
    runs-on: ubuntu-latest
    needs: sanity-check
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Clear Cache âŒ
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh extension install actions/gh-actions-cache
          gh actions-cache delete ${{ runner.os }}-schemas --confirm
        continue-on-error: true

      - name: Install Dependencies âš™ï¸
        run: sudo apt-get install -y opencc

      - name: Fetch Schemas ğŸ“¥
        run: |
          bash scripts/fetch.sh --setver ${{ github.ref_name }}

      - name: Cache Schemas ğŸ’¾
        uses: actions/cache/save@v3
        if: always()
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

  build-package:
    strategy:
      matrix:
        target: [ weasel, hamster, irime, squirrel ]
        include:
          - { target: weasel, name: Weasel, emoji: ğŸ¦¡ }
          - { target: hamster, name: Hamster, emoji: ğŸ¹ }
          - { target: irime, name: iRime, emoji: â„¹ï¸ }
          - { target: squirrel, name: Squirrel, emoji: ğŸ¿ï¸ }
    name: Build Package for ${{ matrix.name }} ${{ matrix.emoji }}
    runs-on: ubuntu-latest
    needs: prepare-schemas
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Cache Schemas ğŸ’¾
        id: cache-schemas
        uses: actions/cache/restore@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

      - name: Check Schema Cache âœ”ï¸
        if: steps.cache-schemas.outputs.cache-hit != 'true'
        uses: actions/github-script@v6
        with:
          script: core.setFailed('Cached schemas not found!')

      - name: Prepare User Settings for Weasel ğŸ¦¡
        if: ${{ matrix.target == 'weasel' }}
        run: |
          cp -r schemas/* ${{ matrix.target }}/ && \
          cp lua/* ${{ matrix.target }}/lua/ && \
          echo "prepare for ${{ matrix.target }} done."

      - name: Prepare User Settings for Hamster ğŸ¹
        if: ${{ matrix.target == 'hamster' }}
        run: |
          mkdir -p ${{ matrix.target }}/lua ${{ matrix.target }}/opencc && \
          cp schemas/jiandao.* schemas/pinyin_simp.* ${{ matrix.target }}/ && \
          cp -r schemas/lua/* lua/* ${{ matrix.target }}/lua/ && \
          cp schemas/opencc/* opencc/* ${{ matrix.target }}/opencc/ && \
          echo "prepare for ${{ matrix.target }} done."

      - name: Prepare User Settings for iRime â„¹ï¸
        if: ${{ matrix.target == 'irime' }}
        run: |
          mkdir -p ${{ matrix.target }}/lua ${{ matrix.target }}/opencc && \
          cp schemas/jiandao.* ${{ matrix.target }}/ && \
          cp -r schemas/lua/* lua/* ${{ matrix.target }}/lua/ && \
          cp schemas/opencc/* opencc/* ${{ matrix.target }}/opencc/ && \
          echo "prepare for ${{ matrix.target }} done."

      - name: Prepare User Settings for Squirrel ğŸ¿ï¸
        if: ${{ matrix.target == 'squirrel' }}
        run: |
          mkdir -p ${{ matrix.target }}/lua ${{ matrix.target }}/opencc && \
          cp -r schemas/* ${{ matrix.target }}/ && \
          cp lua/* ${{ matrix.target }}/lua/ && \
          echo "prepare for ${{ matrix.target }} done."

      - name: Make Zip Archive ğŸ—„ï¸
        run: |
          cd ${{ matrix.target }}
          zip -r -q ../${{ matrix.target }}.zip *

      - name: Upload Artifact ğŸ“¤
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.target }}.zip
          path: ${{ matrix.target }}.zip

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: prepare-schemas
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Create Release ğŸš€
        uses: softprops/action-gh-release@v1

  upload-assets:
    strategy:
      matrix:
        target: [ weasel, hamster, irime, squirrel ]
        include:
          - { target: weasel, name: Weasel, emoji: ğŸ¦¡ }
          - { target: hamster, name: Hamster, emoji: ğŸ¹ }
          - { target: irime, name: iRime, emoji: â„¹ï¸ }
          - { target: squirrel, name: Squirrel, emoji: ğŸ¿ï¸ }
    name: Upload Assets of ${{ matrix.name }} ${{ matrix.emoji }}
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [ build-package, create-release ]
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Download Artifacts of ${{ matrix.name }} ${{ matrix.emoji }}
        uses: actions/download-artifact@v3
        with:
          name: ${{ matrix.target }}.zip

      - name: Rename Release Zip Archives ğŸ—ƒï¸
        run: mv ${{ matrix.target }}.zip ${{ matrix.target }}-${{ github.ref_name }}.zip

      - name: Upload Assets ğŸš€
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.target }}-${{ github.ref_name }}.zip
