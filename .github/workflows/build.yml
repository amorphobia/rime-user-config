name: Build Rime Configs
on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  prepare-schemas:
    name: Prepare Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Fetch Schemas 📥
        run: |
          bash fetch.sh

      - name: Cache Schemas 💾
        uses: actions/cache@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

  prepare-user-dicts:
    name: Prepare User Dicts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Download Jiandao Dicts 📥
        uses: robinraju/release-downloader@v1.7
        with:
          repository: amorphobia/jiandao-user-dict
          latest: true
          fileName: "xkjd6.user.dict.yaml"
          out-file-path: "user_dicts"
          token: ${{ secrets.JIANDAO_USER_DICT_TOKEN }}

      - name: Cache User Dicts 💾
        uses: actions/cache@v3
        with:
          path: user_dicts
          key: ${{ runner.os }}-user_dicts

  build-for-weasel:
    name: Build for Weasel
    runs-on: ubuntu-latest
    needs: [prepare-schemas, prepare-user-dicts]
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Cache Schemas 💾
        id: cache-schemas
        uses: actions/cache@v3
        with:
          path: schemas
          key: ${{ runner.os }}-schemas

      - name: Cache User Dicts 💾
        id: cache-user-dicts
        uses: actions/cache@v3
        with:
          path: user_dicts
          key: ${{ runner.os }}-user_dicts

      - name: Check Schema Cache ✔️
        if: steps.cache-schemas.outputs.cache-hit != 'true'
        uses: actions/github-script@v6
        with:
          script: core.setFailed('Cached schemas not found!')

      - name: Prepare User Settings and Dicts 🗂️
        run: |
          cp -r schemas/* weasel/
          cp lua/* weasel/lua/
          cat rime.lua >> weasel/rime.lua
          cp user_dicts/* weasel/

      - name: Make Zip Archive 🗄️
        run: |
          zip -r -q weasel.zip weasel

      - name: Upload Artifact 📤
        uses: actions/upload-artifact@v3
        with:
          name: weasel.zip
          path: weasel.zip
